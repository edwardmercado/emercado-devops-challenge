AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: >
  Tier-1: Beginner Challenge - Elastic Beanstalk - CICD Stack

Resources:
  ArtifactBucket:
    Type: AWS::S3::Bucket

  CodePipelineServiceRole:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - codepipeline.amazonaws.com
                - codebuild.amazonaws.com
                - codedeploy.amazonaws.com
                - s3.amazonaws.com
                - cloudformation.amazonaws.com
            Action:
              - 'sts:AssumeRole'
      Path: /
      Policies:
        - PolicyName: root
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action: '*'
                Resource: '*'
  #Code Build
  # AppCodeBuildProject:
  #   Type: AWS::CodeBuild::Project
  #   Properties:
  #     Name: DevOpsChallenge-Tier1
  #     Description: A description about my project
  #     ServiceRole: !GetAtt CodePipelineServiceRole.Arn
  #     Artifacts:
  #       Type: no_artifacts
  #     Environment:
  #       Type: LINUX_CONTAINER
  #       ComputeType: BUILD_GENERAL1_SMALL
  #       Image: aws/codebuild/amazonlinux2-x86_64-standard:2.0
  #       # EnvironmentVariables:
  #       # - Name: varName
  #       #   Type: varType
  #       #   Value: varValue
  #     Source:
  #       Location: !Ref ArtifactBucket
  #       Type: S3
  #     TimeoutInMinutes: 10
  #     # Tags:
  #     #   - Key: Key1
  #     #     Value: Value1
  #     #   - Key: Key2
  #     #     Value: Value2

  #Code Pipeline
  AppPipeline: 
    Type: AWS::CodePipeline::Pipeline 
    Properties: 
      ArtifactStore:
        Location: !Ref ArtifactBucket
        Type: S3
      RoleArn: !GetAtt CodePipelineServiceRole.Arn
      Stages: 
        - 
          Name: Source 
          Actions: 
            - 
              Name: SourceAction
              ActionTypeId: 
                Category: Source 
                Owner: AWS 
                Version: '1' 
                Provider: CodeStarSourceConnection          
              OutputArtifacts: 
                - 
                  Name: SourceArtifact 
              Configuration: 
                ConnectionArn: !GetAtt CodeStarConnection.ConnectionArn
                FullRepositoryId: edwardmercado/apper-devops-technical-challenge-tier-1
                BranchName: main
                OutputArtifactFormat: CODE_ZIP
              RunOrder: 1 
        - 
          Name: Beta 
          Actions: 
            - 
              Name: BetaAction 
              InputArtifacts: 
                -
                  Name: SourceArtifact
              ActionTypeId: 
                Category: Deploy 
                Owner: AWS
                Version: 1 
                Provider: CodeDeploy
              Configuration: 
                ApplicationName: DevOpsChallenge-1
                DeploymentGroupName: DevOpsChallenge-fleet
              RunOrder: 1 
        # - 
        #   Name: Release 
        #   Actions: 
        #     - 
        #       Name: ReleaseAction
        #       InputArtifacts: 
        #         - 
        #           Name: SourceOutput 
        #       ActionTypeId: 
        #         Category: Deploy 
        #         Owner: AWS 
        #         Version: 1
        #         Provider: CodeDeploy 
        #       Configuration: 
        #         ApplicationName: 
        #           Ref: ApplicationName
        #         DeploymentGroupName: 
        #           Ref: DeploymentGroupName 
        #       RunOrder: 1 
      # ArtifactStore: 
      #   Type: S3 
      #   Location: !GetAtt ArtifactBucket.Arn

  CodeStarConnection:
    Type: 'AWS::CodeStarConnections::Connection'
    Properties:
      ConnectionName: GitHubToPipelineConnection-tier1
      ProviderType: GitHub

  # AppPipelineWebhook: 
  #   Type: 'AWS::CodePipeline::Webhook' 
  #   Properties:
  #     AuthenticationConfiguration: 
  #       SecretToken: f0899a05de1df332bcf155b9f10426b47fa49b58
  #     Filters: 
  #     - JsonPath: "$.ref" 
  #       MatchEquals: refs/heads/{Branch} 
  #     Authentication: GITHUB_HMAC 
  #     TargetPipeline: !Ref AppPipeline
  #     TargetAction: Source 
  #     Name: MyWebhook 
  #     RegisterWithThirdParty: 'true'  
  #     TargetPipelineVersion: !GetAtt AppPipeline.Version


#Outputs:
